<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "d72a1d9e9ad1a7cc8d40d05d546b5ca0",
  "translation_date": "2025-09-30T13:59:00+00:00",
  "source_file": "11-MCPServerHandsOnLabs/01-Architecture/README.md",
  "language_code": "hi"
}
-->
# рдХреЛрд░ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдЕрд╡рдзрд╛рд░рдгрд╛рдПрдБ

## ЁЯОп рдпрд╣ рд▓реИрдм рдХреНрдпрд╛ рдХрд╡рд░ рдХрд░рддрд╛ рд╣реИ

рдпрд╣ рд▓реИрдм MCP рд╕рд░реНрд╡рд░ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдкреИрдЯрд░реНрди, рдбреЗрдЯрд╛рдмреЗрд╕ рдбрд┐рдЬрд╝рд╛рдЗрди рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ, рдФрд░ рддрдХрдиреАрдХреА рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд░рдгрдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЧрд╣рди рдЕрдиреНрд╡реЗрд╖рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдордЬрдмреВрдд, рд╕реНрдХреЗрд▓реЗрдмрд▓ рдФрд░ рдбреЗрдЯрд╛рдмреЗрд╕-рдЗрдВрдЯреАрдЧреНрд░реЗрдЯреЗрдб AI рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рд╢рдХреНрддрд┐ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред

## рдЕрд╡рд▓реЛрдХрди

рдбреЗрдЯрд╛рдмреЗрд╕ рдЗрдВрдЯреАрдЧреНрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рдПрдХ рдкреНрд░реЛрдбрдХреНрд╢рди-рд░реЗрдбреА MCP рд╕рд░реНрд╡рд░ рдмрдирд╛рдирд╛ рд╕рд╛рд╡рдзрд╛рдиреАрдкреВрд░реНрд╡рдХ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░рд▓ рдирд┐рд░реНрдгрдпреЛрдВ рдХреА рдорд╛рдВрдЧ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рд▓реИрдм рд╣рдорд╛рд░реЗ рдЬрд╝рд╛рд╡рд╛ рд░рд┐рдЯреЗрд▓ рдПрдирд╛рд▓рд┐рдЯрд┐рдХреНрд╕ рд╕рдорд╛рдзрд╛рди рдХреЛ рдордЬрдмреВрдд, рд╕реБрд░рдХреНрд╖рд┐рдд рдФрд░ рд╕реНрдХреЗрд▓реЗрдмрд▓ рдмрдирд╛рдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рдореБрдЦ рдШрдЯрдХреЛрдВ, рдбрд┐рдЬрд╝рд╛рдЗрди рдкреИрдЯрд░реНрди рдФрд░ рддрдХрдиреАрдХреА рд╡рд┐рдЪрд╛рд░реЛрдВ рдХреЛ рддреЛрдбрд╝рдХрд░ рд╕рдордЭрд╛рддрд╛ рд╣реИред

рдЖрдк рд╕рдордЭреЗрдВрдЧреЗ рдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рд▓реЗрдпрд░ рдХреИрд╕реЗ рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рддреА рд╣реИ, рдХреНрдпреЛрдВ рд╡рд┐рд╢рд┐рд╖реНрдЯ рддрдХрдиреАрдХреЛрдВ рдХреЛ рдЪреБрдирд╛ рдЧрдпрд╛, рдФрд░ рдЗрди рдкреИрдЯрд░реНрдиреНрд╕ рдХреЛ рдЕрдкрдиреЗ MCP рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВред

## рд╕реАрдЦрдиреЗ рдХреЗ рдЙрджреНрджреЗрд╢реНрдп

рдЗрд╕ рд▓реИрдм рдХреЗ рдЕрдВрдд рддрдХ, рдЖрдк рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗ:

- **рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВ**: рдбреЗрдЯрд╛рдмреЗрд╕ рдЗрдВрдЯреАрдЧреНрд░реЗрд╢рди рдХреЗ рд╕рд╛рде MCP рд╕рд░реНрд╡рд░ рдХреА рд▓реЗрдпрд░реНрдб рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХрд╛  
- **рд╕рдордЭреЗрдВ**: рдкреНрд░рддреНрдпреЗрдХ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░рд▓ рдШрдЯрдХ рдХреА рднреВрдорд┐рдХрд╛ рдФрд░ рдЬрд┐рдореНрдореЗрджрд╛рд░рд┐рдпрд╛рдБ  
- **рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд░реЗрдВ**: рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрдЯ MCP рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рд╡рд╛рд▓реА рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реНрдХреАрдорд╛рдПрдБ  
- **рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд░реЗрдВ**: рдХрдиреЗрдХреНрд╢рди рдкреВрд▓рд┐рдВрдЧ рдФрд░ рд╕рдВрд╕рд╛рдзрди рдкреНрд░рдмрдВрдзрди рд░рдгрдиреАрддрд┐рдпрд╛рдБ  
- **рд▓рд╛рдЧреВ рдХрд░реЗрдВ**: рдкреНрд░реЛрдбрдХреНрд╢рди рд╕рд┐рд╕реНрдЯрдореНрд╕ рдХреЗ рд▓рд┐рдП рдПрд░рд░ рд╣реИрдВрдбрд▓рд┐рдВрдЧ рдФрд░ рд▓реЙрдЧрд┐рдВрдЧ рдкреИрдЯрд░реНрди  
- **рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░реЗрдВ**: рд╡рд┐рднрд┐рдиреНрди рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░рд▓ рджреГрд╖реНрдЯрд┐рдХреЛрдгреЛрдВ рдХреЗ рдмреАрдЪ рдЯреНрд░реЗрдб-рдСрдл  

## ЁЯПЧя╕П MCP рд╕рд░реНрд╡рд░ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рд▓реЗрдпрд░реНрд╕

рд╣рдорд╛рд░рд╛ MCP рд╕рд░реНрд╡рд░ **рд▓реЗрдпрд░реНрдб рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░** рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЪрд┐рдВрддрд╛рдУрдВ рдХреЛ рдЕрд▓рдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд░рдЦрд░рдЦрд╛рд╡ рдХреЛ рдмрдврд╝рд╛рд╡рд╛ рджреЗрддрд╛ рд╣реИ:

### рд▓реЗрдпрд░ 1: рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд▓реЗрдпрд░ (FastMCP)
**рдЬрд┐рдореНрдореЗрджрд╛рд░реА**: MCP рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕рдВрдЪрд╛рд░ рдФрд░ рд╕рдВрджреЗрд╢ рд░реВрдЯрд┐рдВрдЧ рдХреЛ рд╕рдВрднрд╛рд▓рдирд╛

```python
# FastMCP server setup
from fastmcp import FastMCP

mcp = FastMCP("Zava Retail Analytics")

# Tool registration with type safety
@mcp.tool()
async def execute_sales_query(
    ctx: Context,
    postgresql_query: Annotated[str, Field(description="Well-formed PostgreSQL query")]
) -> str:
    """Execute PostgreSQL queries with Row Level Security."""
    return await query_executor.execute(postgresql_query, ctx)
```

**рдореБрдЦреНрдп рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ**:
- **рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЕрдиреБрдкрд╛рд▓рди**: MCP рд╡рд┐рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдкреВрд░реНрдг рд╕рдорд░реНрдерди  
- **рдЯрд╛рдЗрдк рд╕реЗрдлреНрдЯреА**: рдЕрдиреБрд░реЛрдз/рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕рддреНрдпрд╛рдкрди рдХреЗ рд▓рд┐рдП Pydantic рдореЙрдбрд▓  
- **рдРрд╕рд┐рдВрдХ рд╕рдорд░реНрдерди**: рдЙрдЪреНрдЪ рд╕рдорд╡рд░реНрддреАрддрд╛ рдХреЗ рд▓рд┐рдП рдиреЙрди-рдмреНрд▓реЙрдХрд┐рдВрдЧ I/O  
- **рдПрд░рд░ рд╣реИрдВрдбрд▓рд┐рдВрдЧ**: рдорд╛рдирдХреАрдХреГрдд рддреНрд░реБрдЯрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдБ  

### рд▓реЗрдпрд░ 2: рдмрд┐рдЬрдиреЗрд╕ рд▓реЙрдЬрд┐рдХ рд▓реЗрдпрд░
**рдЬрд┐рдореНрдореЗрджрд╛рд░реА**: рдмрд┐рдЬрдиреЗрд╕ рдирд┐рдпрдореЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдирд╛ рдФрд░ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдФрд░ рдбреЗрдЯрд╛ рд▓реЗрдпрд░реНрд╕ рдХреЗ рдмреАрдЪ рд╕рдордиреНрд╡рдп рдХрд░рдирд╛

```python
class SalesAnalyticsService:
    """Business logic for retail analytics operations."""
    
    async def get_store_performance(
        self, 
        store_id: str, 
        time_period: str
    ) -> Dict[str, Any]:
        """Calculate store performance metrics."""
        
        # Validate business rules
        if not self._validate_store_access(store_id):
            raise UnauthorizedError("Access denied for store")
        
        # Coordinate data retrieval
        sales_data = await self.db_provider.get_sales_data(store_id, time_period)
        metrics = self._calculate_metrics(sales_data)
        
        return {
            "store_id": store_id,
            "period": time_period,
            "metrics": metrics,
            "insights": self._generate_insights(metrics)
        }
```

**рдореБрдЦреНрдп рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ**:
- **рдмрд┐рдЬрдиреЗрд╕ рдирд┐рдпрдо рдкреНрд░рд╡рд░реНрддрди**: рд╕реНрдЯреЛрд░ рдПрдХреНрд╕реЗрд╕ рд╕рддреНрдпрд╛рдкрди рдФрд░ рдбреЗрдЯрд╛ рдЕрдЦрдВрдбрддрд╛  
- **рд╕реЗрд╡рд╛ рд╕рдордиреНрд╡рдп**: рдбреЗрдЯрд╛рдмреЗрд╕ рдФрд░ AI рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдмреАрдЪ рдСрд░реНрдХреЗрд╕реНрдЯреНрд░реЗрд╢рди  
- **рдбреЗрдЯрд╛ рдЯреНрд░рд╛рдВрд╕рдлреЙрд░реНрдореЗрд╢рди**: рдХрдЪреНрдЪреЗ рдбреЗрдЯрд╛ рдХреЛ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рдЕрдВрддрд░реНрджреГрд╖реНрдЯрд┐ рдореЗрдВ рдмрджрд▓рдирд╛  
- **рдХреИрд╢рд┐рдВрдЧ рд░рдгрдиреАрддрд┐**: рдмрд╛рд░-рдмрд╛рд░ рдкреВрдЫреЗ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рд╢реНрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рджрд░реНрд╢рди рдЕрдиреБрдХреВрд▓рди  

### рд▓реЗрдпрд░ 3: рдбреЗрдЯрд╛ рдПрдХреНрд╕реЗрд╕ рд▓реЗрдпрд░
**рдЬрд┐рдореНрдореЗрджрд╛рд░реА**: рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди, рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрди, рдФрд░ рдбреЗрдЯрд╛ рдореИрдкрд┐рдВрдЧ рдХрд╛ рдкреНрд░рдмрдВрдзрди

```python
class PostgreSQLProvider:
    """Data access layer for PostgreSQL operations."""
    
    def __init__(self, connection_config: Dict[str, Any]):
        self.connection_pool: Optional[Pool] = None
        self.config = connection_config
    
    async def execute_query(
        self, 
        query: str, 
        rls_user_id: str
    ) -> List[Dict[str, Any]]:
        """Execute query with RLS context."""
        
        async with self.connection_pool.acquire() as conn:
            # Set RLS context
            await conn.execute(
                "SELECT set_config('app.current_rls_user_id', $1, false)",
                rls_user_id
            )
            
            # Execute query with timeout
            try:
                rows = await asyncio.wait_for(
                    conn.fetch(query),
                    timeout=30.0
                )
                return [dict(row) for row in rows]
            except asyncio.TimeoutError:
                raise QueryTimeoutError("Query execution exceeded timeout")
```

**рдореБрдЦреНрдп рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ**:
- **рдХрдиреЗрдХреНрд╢рди рдкреВрд▓рд┐рдВрдЧ**: рдХреБрд╢рд▓ рд╕рдВрд╕рд╛рдзрди рдкреНрд░рдмрдВрдзрди  
- **рд▓реЗрди-рджреЗрди рдкреНрд░рдмрдВрдзрди**: ACID рдЕрдиреБрдкрд╛рд▓рди рдФрд░ рд░реЛрд▓рдмреИрдХ рд╣реИрдВрдбрд▓рд┐рдВрдЧ  
- **рдХреНрд╡реЗрд░реА рдЕрдиреБрдХреВрд▓рди**: рдкреНрд░рджрд░реНрд╢рди рдирд┐рдЧрд░рд╛рдиреА рдФрд░ рдЕрдиреБрдХреВрд▓рди  
- **RLS рдЗрдВрдЯреАрдЧреНрд░реЗрд╢рди**: рд░реЛ-рд▓реЗрд╡рд▓ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн рдкреНрд░рдмрдВрдзрди  

### рд▓реЗрдпрд░ 4: рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд▓реЗрдпрд░
**рдЬрд┐рдореНрдореЗрджрд╛рд░реА**: рд▓реЙрдЧрд┐рдВрдЧ, рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ, рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдЬреИрд╕реА рдХреНрд░реЙрд╕-рдХрдЯрд┐рдВрдЧ рдЪрд┐рдВрддрд╛рдУрдВ рдХреЛ рд╕рдВрднрд╛рд▓рдирд╛

```python
class InfrastructureManager:
    """Infrastructure concerns management."""
    
    def __init__(self):
        self.logger = self._setup_logging()
        self.metrics = self._setup_metrics()
        self.config = self._load_configuration()
    
    def _setup_logging(self) -> Logger:
        """Configure structured logging."""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.StreamHandler(),
                logging.FileHandler('mcp_server.log')
            ]
        )
        return logging.getLogger(__name__)
    
    async def track_query_execution(
        self, 
        query_type: str, 
        duration: float, 
        success: bool
    ):
        """Track query performance metrics."""
        self.metrics.counter('query_total').labels(
            type=query_type,
            status='success' if success else 'error'
        ).inc()
        
        self.metrics.histogram('query_duration').labels(
            type=query_type
        ).observe(duration)
```

## ЁЯЧДя╕П рдбреЗрдЯрд╛рдмреЗрд╕ рдбрд┐рдЬрд╝рд╛рдЗрди рдкреИрдЯрд░реНрди

рд╣рдорд╛рд░реА PostgreSQL рд╕реНрдХреАрдорд╛ рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрдЯ MCP рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдХрдИ рдкреНрд░рдореБрдЦ рдкреИрдЯрд░реНрди рд▓рд╛рдЧреВ рдХрд░рддреА рд╣реИ:

### 1. рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрдЯ рд╕реНрдХреАрдорд╛ рдбрд┐рдЬрд╝рд╛рдЗрди

```sql
-- Core retail entities with store-based partitioning
CREATE TABLE retail.stores (
    store_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    location VARCHAR(200) NOT NULL,
    manager_id UUID NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE retail.customers (
    customer_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id UUID REFERENCES retail.stores(store_id),
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE retail.orders (
    order_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID REFERENCES retail.customers(customer_id),
    store_id UUID REFERENCES retail.stores(store_id),
    order_date TIMESTAMP DEFAULT NOW(),
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending'
);
```

**рдбрд┐рдЬрд╝рд╛рдЗрди рд╕рд┐рджреНрдзрд╛рдВрдд**:
- **рдлреЙрд░реЗрди рдХреА рд╕рдВрдЧрддрд┐**: рддрд╛рд▓рд┐рдХрд╛рдУрдВ рдХреЗ рдмреАрдЪ рдбреЗрдЯрд╛ рдЕрдЦрдВрдбрддрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛  
- **рд╕реНрдЯреЛрд░ ID рдкреНрд░рдЪрд╛рд░**: рдкреНрд░рддреНрдпреЗрдХ рд▓реЗрди-рджреЗрди рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ store_id рд╢рд╛рдорд┐рд▓ рдХрд░рдирд╛  
- **UUID рдкреНрд░рд╛рдердорд┐рдХ рдХреБрдВрдЬрд┐рдпрд╛рдБ**: рд╡рд┐рддрд░рд┐рдд рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рдЕрджреНрд╡рд┐рддреАрдп рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛  
- **рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдЯреНрд░реИрдХрд┐рдВрдЧ**: рд╕рднреА рдбреЗрдЯрд╛ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдСрдбрд┐рдЯ рдЯреНрд░реЗрд▓  

### 2. рд░реЛ рд▓реЗрд╡рд▓ рд╕реБрд░рдХреНрд╖рд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди

```sql
-- Enable RLS on multi-tenant tables
ALTER TABLE retail.customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE retail.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE retail.order_items ENABLE ROW LEVEL SECURITY;

-- Store manager can only see their store's data
CREATE POLICY store_manager_customers ON retail.customers
    FOR ALL TO store_managers
    USING (store_id = get_current_user_store());

CREATE POLICY store_manager_orders ON retail.orders
    FOR ALL TO store_managers
    USING (store_id = get_current_user_store());

-- Regional managers see multiple stores
CREATE POLICY regional_manager_orders ON retail.orders
    FOR ALL TO regional_managers
    USING (store_id = ANY(get_user_store_list()));

-- Support function for RLS context
CREATE OR REPLACE FUNCTION get_current_user_store()
RETURNS UUID AS $$
BEGIN
    RETURN current_setting('app.current_rls_user_id')::UUID;
EXCEPTION WHEN OTHERS THEN
    RETURN '00000000-0000-0000-0000-000000000000'::UUID;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**RLS рд▓рд╛рдн**:
- **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ**: рдбреЗрдЯрд╛рдмреЗрд╕ рдбреЗрдЯрд╛ рдЕрд▓рдЧрд╛рд╡ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ  
- **рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕рд╛рджрдЧреА**: рдЬрдЯрд┐рд▓ WHERE рдХреНрд▓реЙрдЬрд╝ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ  
- **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛**: рдЧрд▓рдд рдбреЗрдЯрд╛ рддрдХ рдЖрдХрд╕реНрдорд┐рдХ рдкрд╣реБрдВрдЪ рдЕрд╕рдВрднрд╡  
- **рдСрдбрд┐рдЯ рдЕрдиреБрдкрд╛рд▓рди**: рд╕реНрдкрд╖реНрдЯ рдбреЗрдЯрд╛ рдПрдХреНрд╕реЗрд╕ рд╕реАрдорд╛рдПрдБ  

### 3. рд╡реЗрдХреНрдЯрд░ рд╕рд░реНрдЪ рд╕реНрдХреАрдорд╛

```sql
-- Product embeddings for semantic search
CREATE TABLE retail.product_description_embeddings (
    product_id UUID PRIMARY KEY REFERENCES retail.products(product_id),
    description_embedding vector(1536),
    last_updated TIMESTAMP DEFAULT NOW()
);

-- Optimize vector similarity search
CREATE INDEX idx_product_embeddings_vector 
ON retail.product_description_embeddings 
USING ivfflat (description_embedding vector_cosine_ops);

-- Semantic search function
CREATE OR REPLACE FUNCTION search_products_by_description(
    query_embedding vector(1536),
    similarity_threshold FLOAT DEFAULT 0.7,
    max_results INTEGER DEFAULT 20
)
RETURNS TABLE(
    product_id UUID,
    name VARCHAR,
    description TEXT,
    similarity_score FLOAT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.product_id,
        p.name,
        p.description,
        (1 - (pde.description_embedding <=> query_embedding)) AS similarity_score
    FROM retail.products p
    JOIN retail.product_description_embeddings pde ON p.product_id = pde.product_id
    WHERE (pde.description_embedding <=> query_embedding) <= (1 - similarity_threshold)
    ORDER BY similarity_score DESC
    LIMIT max_results;
END;
$$ LANGUAGE plpgsql;
```

## ЁЯФМ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдмрдВрдзрди рдкреИрдЯрд░реНрди

MCP рд╕рд░реНрд╡рд░ рдкреНрд░рджрд░реНрд╢рди рдХреЗ рд▓рд┐рдП рдХреБрд╢рд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдмрдВрдзрди рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ:

### рдХрдиреЗрдХреНрд╢рди рдкреВрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

```python
class ConnectionPoolManager:
    """Manages PostgreSQL connection pools."""
    
    async def create_pool(self) -> Pool:
        """Create optimized connection pool."""
        return await asyncpg.create_pool(
            host=self.config.db_host,
            port=self.config.db_port,
            database=self.config.db_name,
            user=self.config.db_user,
            password=self.config.db_password,
            
            # Pool configuration
            min_size=2,          # Minimum connections
            max_size=10,         # Maximum connections
            max_inactive_connection_lifetime=300,  # 5 minutes
            
            # Query configuration
            command_timeout=30,   # Query timeout
            server_settings={
                "application_name": "zava-mcp-server",
                "jit": "off",          # Disable JIT for stability
                "work_mem": "4MB",     # Limit work memory
                "statement_timeout": "30s"
            }
        )
    
    async def execute_with_retry(
        self, 
        query: str, 
        params: Tuple = None,
        max_retries: int = 3
    ) -> List[Dict[str, Any]]:
        """Execute query with automatic retry logic."""
        
        for attempt in range(max_retries):
            try:
                async with self.pool.acquire() as conn:
                    if params:
                        rows = await conn.fetch(query, *params)
                    else:
                        rows = await conn.fetch(query)
                    return [dict(row) for row in rows]
                    
            except (ConnectionError, InterfaceError) as e:
                if attempt == max_retries - 1:
                    raise
                
                # Exponential backoff
                await asyncio.sleep(2 ** attempt)
                logger.warning(f"Database connection failed, retrying ({attempt + 1}/{max_retries})")
```

### рд╕рдВрд╕рд╛рдзрди рдЬреАрд╡рдирдЪрдХреНрд░ рдкреНрд░рдмрдВрдзрди

```python
class MCPServerManager:
    """Manages MCP server lifecycle and resources."""
    
    async def startup(self):
        """Initialize server resources."""
        # Create database connection pool
        self.db_pool = await self.pool_manager.create_pool()
        
        # Initialize AI services
        self.ai_client = await self.create_ai_client()
        
        # Setup monitoring
        self.metrics_collector = MetricsCollector()
        
        logger.info("MCP server startup complete")
    
    async def shutdown(self):
        """Cleanup server resources."""
        try:
            # Close database connections
            if self.db_pool:
                await self.db_pool.close()
            
            # Cleanup AI client
            if self.ai_client:
                await self.ai_client.close()
            
            # Flush metrics
            await self.metrics_collector.flush()
            
            logger.info("MCP server shutdown complete")
            
        except Exception as e:
            logger.error(f"Error during shutdown: {e}")
    
    async def health_check(self) -> Dict[str, str]:
        """Verify server health status."""
        status = {}
        
        # Check database connection
        try:
            async with self.db_pool.acquire() as conn:
                await conn.fetchval("SELECT 1")
            status["database"] = "healthy"
        except Exception as e:
            status["database"] = f"unhealthy: {e}"
        
        # Check AI service
        try:
            await self.ai_client.health_check()
            status["ai_service"] = "healthy"
        except Exception as e:
            status["ai_service"] = f"unhealthy: {e}"
        
        return status
```

## ЁЯЫбя╕П рдПрд░рд░ рд╣реИрдВрдбрд▓рд┐рдВрдЧ рдФрд░ рд▓рдЪреАрд▓рд╛рдкрди рдкреИрдЯрд░реНрди

рдордЬрдмреВрдд рдПрд░рд░ рд╣реИрдВрдбрд▓рд┐рдВрдЧ MCP рд╕рд░реНрд╡рд░ рдХреЗ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╕рдВрдЪрд╛рд▓рди рдХреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИ:

### рдкрджрд╛рдиреБрдХреНрд░рдорд┐рдд рддреНрд░реБрдЯрд┐ рдкреНрд░рдХрд╛рд░

```python
class MCPError(Exception):
    """Base MCP server error."""
    def __init__(self, message: str, error_code: str = "MCP_ERROR"):
        self.message = message
        self.error_code = error_code
        super().__init__(message)

class DatabaseError(MCPError):
    """Database operation errors."""
    def __init__(self, message: str, query: str = None):
        super().__init__(message, "DATABASE_ERROR")
        self.query = query

class AuthorizationError(MCPError):
    """Access control errors."""
    def __init__(self, message: str, user_id: str = None):
        super().__init__(message, "AUTHORIZATION_ERROR")
        self.user_id = user_id

class QueryTimeoutError(DatabaseError):
    """Query execution timeout."""
    def __init__(self, query: str):
        super().__init__(f"Query timeout: {query[:100]}...", query)
        self.error_code = "QUERY_TIMEOUT"

class ValidationError(MCPError):
    """Input validation errors."""
    def __init__(self, field: str, value: Any, constraint: str):
        message = f"Validation failed for {field}: {constraint}"
        super().__init__(message, "VALIDATION_ERROR")
        self.field = field
        self.value = value
```

### рдПрд░рд░ рд╣реИрдВрдбрд▓рд┐рдВрдЧ рдорд┐рдбрд▓рд╡реЗрдпрд░

```python
@contextmanager
async def error_handling_context(operation_name: str, user_id: str = None):
    """Centralized error handling for operations."""
    start_time = time.time()
    
    try:
        yield
        
        # Success metrics
        duration = time.time() - start_time
        metrics.operation_success.labels(operation=operation_name).inc()
        metrics.operation_duration.labels(operation=operation_name).observe(duration)
        
    except ValidationError as e:
        logger.warning(f"Validation error in {operation_name}: {e.message}", extra={
            "operation": operation_name,
            "user_id": user_id,
            "error_type": "validation",
            "field": e.field
        })
        metrics.operation_error.labels(operation=operation_name, type="validation").inc()
        raise
        
    except AuthorizationError as e:
        logger.warning(f"Authorization error in {operation_name}: {e.message}", extra={
            "operation": operation_name,
            "user_id": user_id,
            "error_type": "authorization"
        })
        metrics.operation_error.labels(operation=operation_name, type="authorization").inc()
        raise
        
    except DatabaseError as e:
        logger.error(f"Database error in {operation_name}: {e.message}", extra={
            "operation": operation_name,
            "user_id": user_id,
            "error_type": "database",
            "query": e.query[:100] if e.query else None
        })
        metrics.operation_error.labels(operation=operation_name, type="database").inc()
        raise
        
    except Exception as e:
        logger.error(f"Unexpected error in {operation_name}: {str(e)}", extra={
            "operation": operation_name,
            "user_id": user_id,
            "error_type": "unexpected"
        }, exc_info=True)
        metrics.operation_error.labels(operation=operation_name, type="unexpected").inc()
        raise MCPError(f"Internal server error in {operation_name}")
```

## ЁЯУК рдкреНрд░рджрд░реНрд╢рди рдЕрдиреБрдХреВрд▓рди рд░рдгрдиреАрддрд┐рдпрд╛рдБ

### рдХреНрд╡реЗрд░реА рдкреНрд░рджрд░реНрд╢рди рдирд┐рдЧрд░рд╛рдиреА

```python
class QueryPerformanceMonitor:
    """Monitor and optimize query performance."""
    
    def __init__(self):
        self.slow_query_threshold = 1.0  # seconds
        self.query_stats = defaultdict(list)
    
    @contextmanager
    async def monitor_query(self, query: str, operation_type: str = "unknown"):
        """Monitor query execution time and performance."""
        start_time = time.time()
        query_hash = hashlib.md5(query.encode()).hexdigest()[:8]
        
        try:
            yield
            
            duration = time.time() - start_time
            
            # Record performance metrics
            self.query_stats[operation_type].append(duration)
            
            # Log slow queries
            if duration > self.slow_query_threshold:
                logger.warning(f"Slow query detected", extra={
                    "query_hash": query_hash,
                    "duration": duration,
                    "operation_type": operation_type,
                    "query": query[:200]
                })
            
            # Update metrics
            metrics.query_duration.labels(type=operation_type).observe(duration)
            
        except Exception as e:
            duration = time.time() - start_time
            logger.error(f"Query failed", extra={
                "query_hash": query_hash,
                "duration": duration,
                "operation_type": operation_type,
                "error": str(e)
            })
            raise
    
    def get_performance_summary(self) -> Dict[str, Any]:
        """Generate performance summary report."""
        summary = {}
        
        for operation_type, durations in self.query_stats.items():
            if durations:
                summary[operation_type] = {
                    "count": len(durations),
                    "avg_duration": sum(durations) / len(durations),
                    "max_duration": max(durations),
                    "min_duration": min(durations),
                    "slow_queries": len([d for d in durations if d > self.slow_query_threshold])
                }
        
        return summary
```

### рдХреИрд╢рд┐рдВрдЧ рд░рдгрдиреАрддрд┐

```python
class QueryCache:
    """Intelligent query result caching."""
    
    def __init__(self, redis_url: str = None):
        self.cache = {}  # In-memory fallback
        self.redis_client = redis.Redis.from_url(redis_url) if redis_url else None
        self.cache_ttl = 300  # 5 minutes default
    
    async def get_cached_result(
        self, 
        cache_key: str, 
        query_func: Callable,
        ttl: int = None
    ) -> Any:
        """Get result from cache or execute query."""
        ttl = ttl or self.cache_ttl
        
        # Try cache first
        cached_result = await self._get_from_cache(cache_key)
        if cached_result is not None:
            metrics.cache_hit.labels(type="query").inc()
            return cached_result
        
        # Execute query
        metrics.cache_miss.labels(type="query").inc()
        result = await query_func()
        
        # Cache result
        await self._set_in_cache(cache_key, result, ttl)
        
        return result
    
    def _generate_cache_key(self, query: str, user_context: str) -> str:
        """Generate consistent cache key."""
        key_data = f"{query}:{user_context}"
        return hashlib.sha256(key_data.encode()).hexdigest()
```

## ЁЯОп рдореБрдЦреНрдп рдирд┐рд╖реНрдХрд░реНрд╖

рдЗрд╕ рд▓реИрдм рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЖрдкрдХреЛ рд╕рдордЭ рдореЗрдВ рдЖрдирд╛ рдЪрд╛рд╣рд┐рдП:

тЬЕ **рд▓реЗрдпрд░реНрдб рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░**: MCP рд╕рд░реНрд╡рд░ рдбрд┐рдЬрд╝рд╛рдЗрди рдореЗрдВ рдЪрд┐рдВрддрд╛рдУрдВ рдХреЛ рдЕрд▓рдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ  
тЬЕ **рдбреЗрдЯрд╛рдмреЗрд╕ рдкреИрдЯрд░реНрди**: рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрдЯ рд╕реНрдХреАрдорд╛ рдбрд┐рдЬрд╝рд╛рдЗрди рдФрд░ RLS рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди  
тЬЕ **рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдмрдВрдзрди**: рдХреБрд╢рд▓ рдкреВрд▓рд┐рдВрдЧ рдФрд░ рд╕рдВрд╕рд╛рдзрди рдЬреАрд╡рдирдЪрдХреНрд░  
тЬЕ **рдПрд░рд░ рд╣реИрдВрдбрд▓рд┐рдВрдЧ**: рдкрджрд╛рдиреБрдХреНрд░рдорд┐рдд рддреНрд░реБрдЯрд┐ рдкреНрд░рдХрд╛рд░ рдФрд░ рд▓рдЪреАрд▓рд╛рдкрди рдкреИрдЯрд░реНрди  
тЬЕ **рдкреНрд░рджрд░реНрд╢рди рдЕрдиреБрдХреВрд▓рди**: рдирд┐рдЧрд░рд╛рдиреА, рдХреИрд╢рд┐рдВрдЧ, рдФрд░ рдХреНрд╡реЗрд░реА рдЕрдиреБрдХреВрд▓рди  
тЬЕ **рдкреНрд░реЛрдбрдХреНрд╢рди рд░реЗрдбреАрдиреЗрд╕**: рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдЪрд┐рдВрддрд╛рдПрдБ рдФрд░ рдкрд░рд┐рдЪрд╛рд▓рди рдкреИрдЯрд░реНрди  

## ЁЯЪА рдЖрдЧреЗ рдХреНрдпрд╛ рдХрд░реЗрдВ

**[рд▓реИрдм 02: рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрд╕реА](../02-Security/README.md)** рдХреЗ рд╕рд╛рде рдЬрд╛рд░реА рд░рдЦреЗрдВ, рдЬрд┐рд╕рдореЗрдВ рдЧрд╣рд░рд╛рдИ рд╕реЗ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

- рд░реЛ рд▓реЗрд╡рд▓ рд╕реБрд░рдХреНрд╖рд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╡рд┐рд╡рд░рдг  
- рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкреИрдЯрд░реНрди  
- рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрдЯ рдбреЗрдЯрд╛ рдЕрд▓рдЧрд╛рд╡ рд░рдгрдиреАрддрд┐рдпрд╛рдБ  
- рд╕реБрд░рдХреНрд╖рд╛ рдСрдбрд┐рдЯ рдФрд░ рдЕрдиреБрдкрд╛рд▓рди рд╡рд┐рдЪрд╛рд░  

## ЁЯУЪ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рдВрд╕рд╛рдзрди

### рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдкреИрдЯрд░реНрди
- [Python рдореЗрдВ рдХреНрд▓реАрди рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░](https://github.com/cosmic-python/code) - Python рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░рд▓ рдкреИрдЯрд░реНрди  
- [рдбреЗрдЯрд╛рдмреЗрд╕ рдбрд┐рдЬрд╝рд╛рдЗрди рдкреИрдЯрд░реНрди](https://en.wikipedia.org/wiki/Database_design) - рд░рд┐рд▓реЗрд╢рдирд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдбрд┐рдЬрд╝рд╛рдЗрди рд╕рд┐рджреНрдзрд╛рдВрдд  
- [рдорд╛рдЗрдХреНрд░реЛрд╕рд░реНрд╡рд┐рд╕реЗрдЬ рдкреИрдЯрд░реНрди](https://microservices.io/patterns/) - рд╕реЗрд╡рд╛ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдкреИрдЯрд░реНрди  

### PostgreSQL рдЙрдиреНрдирдд рд╡рд┐рд╖рдп
- [PostgreSQL рдкреНрд░рджрд░реНрд╢рди рдЯреНрдпреВрдирд┐рдВрдЧ](https://wiki.postgresql.org/wiki/Performance_Optimization) - рдбреЗрдЯрд╛рдмреЗрд╕ рдЕрдиреБрдХреВрд▓рди рдЧрд╛рдЗрдб  
- [рдХрдиреЗрдХреНрд╢рди рдкреВрд▓рд┐рдВрдЧ рд╕рд░реНрд╡реЛрддреНрддрдо рдкреНрд░рдерд╛рдПрдБ](https://www.postgresql.org/docs/current/runtime-config-connection.html) - рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдмрдВрдзрди  
- [рдХреНрд╡реЗрд░реА рдкреНрд▓рд╛рдирд┐рдВрдЧ рдФрд░ рдЕрдиреБрдХреВрд▓рди](https://www.postgresql.org/docs/current/planner-optimizer.html) - рдХреНрд╡реЗрд░реА рдкреНрд░рджрд░реНрд╢рди  

### Python рдРрд╕рд┐рдВрдХ рдкреИрдЯрд░реНрди
- [AsyncIO рд╕рд░реНрд╡реЛрддреНрддрдо рдкреНрд░рдерд╛рдПрдБ](https://docs.python.org/3/library/asyncio.html) - рдРрд╕рд┐рдВрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдкреИрдЯрд░реНрди  
- [FastAPI рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░](https://fastapi.tiangolo.com/advanced/) - рдЖрдзреБрдирд┐рдХ Python рд╡реЗрдм рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░  
- [Pydantic рдореЙрдбрд▓](https://pydantic-docs.helpmanual.io/) - рдбреЗрдЯрд╛ рд╕рддреНрдпрд╛рдкрди рдФрд░ рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬрд╝реЗрд╢рди  

---

**рдЕрдЧрд▓рд╛**: рд╕реБрд░рдХреНрд╖рд╛ рдкреИрдЯрд░реНрди рдХрд╛ рдЕрдиреНрд╡реЗрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИрдВ? [рд▓реИрдм 02: рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрд╕реА](../02-Security/README.md) рдХреЗ рд╕рд╛рде рдЬрд╛рд░реА рд░рдЦреЗрдВред

---

**рдЕрд╕реНрд╡реАрдХрд░рдг**:  
рдпрд╣ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ AI рдЕрдиреБрд╡рд╛рдж рд╕реЗрд╡рд╛ [Co-op Translator](https://github.com/Azure/co-op-translator) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдиреБрд╡рд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЬрдмрдХрд┐ рд╣рдо рд╕рдЯреАрдХрддрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЕрдиреБрд╡рд╛рдж рдореЗрдВ рддреНрд░реБрдЯрд┐рдпрд╛рдВ рдпрд╛ рдЕрд╢реБрджреНрдзрд┐рдпрд╛рдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВред рдореВрд▓ рднрд╛рд╖рд╛ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рдореВрд▓ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЛ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рд╕реНрд░реЛрдд рдорд╛рдирд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП, рдкреЗрд╢реЗрд╡рд░ рдорд╛рдирд╡ рдЕрдиреБрд╡рд╛рдж рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИред рдЗрд╕ рдЕрдиреБрд╡рд╛рдж рдХреЗ рдЙрдкрдпреЛрдЧ рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рд╕реА рднреА рдЧрд▓рддрдлрд╣рдореА рдпрд╛ рдЧрд▓рдд рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреЗ рд▓рд┐рдП рд╣рдо рдЙрддреНрддрд░рджрд╛рдпреА рдирд╣реАрдВ рд╣реИрдВред